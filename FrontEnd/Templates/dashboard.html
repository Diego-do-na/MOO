<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #1e88e5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
        .controls label { font-weight: bold; margin-right: 10px; }
        .controls select { padding: 8px; border-radius: 4px; border: 1px solid #aaa; }
        .controls button { padding: 8px 15px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .controls button:hover { background-color: #43a047; }
        
        /* Estilos de la tarjeta (Card) */
        .card { border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin-bottom: 20px; background-color: #ffffff; }
        .card-header { background-color: #1e88e5; color: white; padding: 10px; margin: -20px -20px 20px -20px; border-top-left-radius: 6px; border-top-right-radius: 6px; font-size: 1.2em; }
        .card p { margin: 5px 0; }
        .card strong { display: inline-block; width: 120px; }

        /* Estilos para el modo "Todos" (Grid) */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card-grid .card { margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚙️ IoT Dashboard Interactivo</h1>

        <div class="controls">
            <form id="device-form" method="GET" action="{{ url_for('dashboard') }}">
                <label for="device_selector">Seleccionar Dispositivo:</label>
                <select name="device_id" id="device_selector">
                    <option value="all" {% if selected_id == 'all' %}selected{% endif %}>Todos</option>
                    
                    {% for id in all_device_ids %}
                        <option value="{{ id }}" {% if selected_id == id|string %}selected{% endif %}>Sensor {{ id }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Mostrar</button>
            </form>
        </div>

        <h2>Resultados para: {{ "Todos los Dispositivos" if is_all else "Sensor " + selected_id }}</h2>
        
        <div class="results">
            {% if is_all %}
            <div class="card-grid">
                {% for device_id, data in dashboard_data.items() %}
                    {% if 'error' in data %}
                        <div class="card" style="border-color: red;">
                            <div class="card-header" style="background-color: #d32f2f;">Sensor {{ device_id }} (ERROR)</div>
                            <p><strong>Error:</strong> {{ data.error }}</p>
                        </div>
                    {% else %}
                        <div class="card">
                            <div class="card-header">Sensor {{ data.sensor_id }}</div>
                            <p><strong>ID:</strong> {{ data.sensor_id }}</p>
                            <p><strong>Último Valor:</strong> {{ data.latest_value }}</p>
                            <p><strong>Última Lectura:</strong> {{ data.latest_timestamp }}</p>
                            <p><strong>Total de Lecturas:</strong> {{ data.total_readings }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            {% else %}
                {% set device_id = selected_id|int %}
                {% set data = dashboard_data.get(device_id, {}) %}
                
                {% if 'error' in data %}
                    <div class="card" style="border-color: red;">
                        <div class="card-header" style="background-color: #d32f2f;">Sensor {{ device_id }} (ERROR)</div>
                        <p><strong>Error de API:</strong> {{ data.error }}</p>
                        <p>Asegúrate de que el ID {{ device_id }} existe y la API está accesible.</p>
                    </div>
                {% elif data %}
                    <div class="card">
                        <div class="card-header">Detalle del Sensor {{ data.sensor_id }}</div>
                        <p><strong>ID del Sensor:</strong> {{ data.sensor_id }}</p>
                        <p><strong>Último Valor:</strong> <span style="font-size: 1.5em; color: #ff9800;">{{ data.latest_value }}</span></p>
                        <p><strong>Hora de Lectura:</strong> {{ data.latest_timestamp }}</p>
                        <p><strong>Lecturas Totales:</strong> {{ data.total_readings }}</p>
                        </div>
                {% else %}
                    <p>No se encontraron datos para el sensor {{ selected_id }} o la base de datos no retornó IDs.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</body>
</html>